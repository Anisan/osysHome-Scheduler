{% extends "scheduler_main.html" %}
{% block tab %}
<script src="{{ config.ASSETS_ROOT }}/plugins/vue/vue@2.js"></script>  
<script src="{{ config.ASSETS_ROOT }}/plugins/vue/axios.min.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
<div id="monitoring_app">  
  <div class="container-fluid">  
     
    <!-- Статистика пула потоков -->  
    <div class="d-flex flex-nowrap">
      <div class="card text-center me-2 mb-2">  
        <div class="card-header">{{ _('Thread Pool Statistics')}}</div>  
                  <div class="card-body">  
                    <h4 class="${statusClass}">[[Object.keys(stats.thread_pool.active_tasks).length]]/[[stats.thread_pool.max_workers]]</h4>  
                    <small class="text-muted">[[stats.thread_pool.pool_utilization.toFixed(2)]]% utilization</small>  
                    <div class="mt-2">  
                        <small>{{ _('Generation')}}: [[stats.thread_pool.pool_generation]]</small><br>
                        <small>{{ _('Completed')}}: [[stats.thread_pool.completed_tasks]]</small><br>
                        <small>{{ _('Failed')}}: [[stats.thread_pool.failed_tasks]]</small><br>
                        <small>{{ _('Rejected')}}: [[stats.thread_pool.rejected_tasks]]</small><br>
                        <small>{{ _('Queue')}}: [[stats.thread_pool.queue_size]]</small><br>
                        <small>{{ _('Max Workers')}}: [[stats.thread_pool.max_workers]]</small><br>  
                        <small>{{ _('Max Active Tasks')}}: [[stats.thread_pool.max_concurrent_tasks]]</small>  
                    </div>  
                  <h6 class="mt-3">{{ _('Execution Time Statistics')}}</h6>
                    <div>  
                        <small>{{ _('Average')}}: [[stats.execution_time.avg_execution_time]]s</small><br>
                        <small>{{ _('Min')}}: [[stats.execution_time.min_execution_time]]s</small><br>
                        <small>{{ _('Max')}}: [[stats.execution_time.max_execution_time]]s</small><br> 
                        <small>{{ _('Total')}}: [[stats.execution_time.total_execution_time]]s</small>  
                    </div>  
                </div>  
      </div>    
      <!-- Графики -->  
      <div class="card mb-2 flex-grow-1">  
        <div class="card-header">{{ _('Execution Time History')}}</div>  
          <div class="card-body" style="height: 400px;">  
            <canvas id="executionChart" style="max-height: 350px;"></canvas>  
          </div>  
      </div>  
    </div>
    <div class="d-flex flex-nowrap">
      <div class="card me-2 flex-grow-1" style="flex-basis: 33.33%;">
        <div class="card-header">{{ _('Active Tasks')}}</div>  
        <div class="card-body">
          <div class="table-responsive">  
            <table id="tasksTable" class="table table-hover table-striped">  
              <thead>  
                <tr>  
                  <th>Task Name</th>  
                  <th>Started</th>  
                </tr>  
              </thead>  
              <tbody id="tasks-tbody">  
                <tr v-for="value,key in stats.thread_pool.active_tasks">
                  <td>[[key]]</td>
                  <td>[[value]]</td>
                </tr>
              </tbody>  
            </table>  
          </div>  
        </div>  
      </div>
      <div class="card  flex-grow-1" style="flex-basis: 66.66%;">
        <div class="card-header">{{ _('Execution Time History')}}</div>  
        <div class="card-body">
          <div class="table-responsive">  
            <table id="tasksTable" class="table table-hover table-striped">  
              <thead>  
                <tr>  
                  <th>Task Name</th>  
                  <th>Started</th>  
                  <th>Duration</th>  
                  <th>Success</th>  
                </tr>  
              </thead>  
              <tbody id="tasks-tbody">  
                <tr v-for="item in stats.history">
                  <td>[[item.task_name]]</td>
                  <td>[[item.time]]</td>
                  <td>[[item.duration]]s</td>
                  <td><span :class="'badge ' + (item.success ? 'bg-success' : 'bg-danger')">[[item.success ? 'Success' : 'Failed']]</span></td>  
                </tr>
              </tbody>  
            </table>  
          </div>  
        </div>  
      </div>
    </div>
  </div>  
</div>  
  
<script>  
new Vue({  
  el: '#monitoring_app',  
  delimiters: ['[[', ']]'],  
  data: {  
    stats: {{ stats|tojson }},  
    chart: null  
  },  
  mounted() {  
    this.initChart();  
    this.startAutoRefresh();  
  },  
  methods: {  
    initChart() {  
      const self = this;
      const ctx = document.getElementById('executionChart').getContext('2d');  
      const history = this.stats.history;
        
      this.chart = new Chart(ctx, {  
        type: 'line',  
        data: {  
          labels: history.map((item, index) => index),  
          datasets: [{  
            label: "{{ _('Execution Time History')}}",  
            data: history.map(item => item.duration),   
            borderColor: 'rgb(75, 192, 192)',  
            backgroundColor: 'rgba(75, 192, 192, 0.2)',  
            tension: 0.1  
          }]  
        },  
        options: {  
            responsive: true,
            maintainAspectRatio: false,
            scales: {  
                x: {  
                    ticks: {  
                    display: false  // Скрываем подписи оси X  
                    }, 
                }, 
                y: {  
                    beginAtZero: true,  
                }  
            },
            plugins: {  
                tooltip: {  
                    callbacks: {  
                        title: function(context) {  
                        const currentHistory = self.stats.history;  
                        const item = currentHistory[context[0].dataIndex];   
                        return `${item.task_name}`;  
                        },  
                        label: function(context) {  
                        const currentHistory = self.stats.history;  
                        const item = currentHistory[context.dataIndex];   
                        const status = item.success ? '✅' : '❌';  
                        return [  
                            `{{ _('Time end')}}: ${item.time}`,  
                            `{{ _('Duration')}}: ${item.duration.toFixed(3)} sec`,  
                            `{{ _('Status')}}: ${status}`  
                        ];  
                        }  
                    }  
                }  
            }    
        }  
      });  
    },  
      
    async refreshStats() {  
      try {  
        const response = await axios.get('/api/Scheduler/monitoring');  
        if (response.data.success) {  
          this.stats = response.data.result;  
          this.updateChart();  
        }  
      } catch (error) {  
        console.error('Error refreshing stats:', error);  
      }  
    },  
      
    updateChart() {  
        const history = this.stats.history;  
        this.chart.data.labels = history.map((item, index) => index);  
        this.chart.data.datasets[0].data = history.map(item => item.duration);  
        this.chart.update();  
    }, 
      
    startAutoRefresh() {  
      setInterval(() => {  
        this.refreshStats();  
      }, 5000); // Обновление каждые 5 секунд  
    }  
  }  
});  
</script>  
{% endblock %}